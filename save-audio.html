<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.3.1/Tone.min.js"></script>
    <script src= "patterns.js"> </script>
</head>
<body>
  <button id="next">PLAY NEXT</button>
  <audio id="x" controls></audio>
</body>
<script>

var audio = document.querySelector('#x');
var actx = Tone.context;
var dest = actx.createMediaStreamDestination();
var recorder = new MediaRecorder(dest.stream);
var highClip = new Tone.Player({
	"url" : "wav/high.wav",
	"autostart" : false,
}).toMaster();
var lowClip = new Tone.Player({
	"url" : "wav/low.wav",
	"autostart" : false,
}).toMaster();

highClip.connect(recorder);
lowClip.connect(recorder);

var pattern = 0;

var chunks = [];
recorder.ondataavailable = function(e){
  chunks.push(e.data);
}
recorder.onstop = function(){
  var blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
  audio.src = URL.createObjectURL(blob);
}

document.querySelector('#next').addEventListener('click', function(){
  PlayPattern(pattern);
  pattern++;
});

function createPart(pattern){
  var part = new Tone.Sequence(function(time, value){
    if(value == 'h'){
      highClip.restart(time);
    }
    if(value == 'l'){
      lowClip.restart(time);
    }
  }, pattern, "8n")
}

function PlayPattern(id){

  var pattern = patterns[id];
  chunks = [];

  actx.resume();
  // if(typeof highClip !== 'undefined'){
  //   highClip.stop();
  //   lowClip.stop();
  // }
  // Tone.Transport.stop();

  var part = createPart(pattern);

  part.start();
  
  Tone.Transport.schedule(function(){
    recorder.stop();
    Tone.Transport.stop();
  }, "5:0:0");

  Tone.Transport.bpm.value = 240;
  recorder.start();
  Tone.Transport.start();
}

</script>
</html>
